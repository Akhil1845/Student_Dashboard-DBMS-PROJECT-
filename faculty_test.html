<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty – Tests</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  body { font-family:'Poppins',sans-serif; background:#f4f6f8; margin:0; }
  .back-btn { position: fixed; top: 20px; left: 20px; background: #1976d2; color: #fff; padding: 8px 14px; border-radius: 6px; text-decoration: none; z-index: 1000; }
  .back-btn:hover { background:#125a9d; }
  .container { max-width:1000px; margin:80px auto 40px auto; background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  h1 { text-align:center; color:#1976d2; margin-bottom:20px; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
  input[type="text"], select { padding:8px 12px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
  button { background:#1976d2; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; }
  button:hover { background:#125a9d; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
  th { background:#f0f0f0; }
  .add-test-form { display:none; margin-top:20px; border:1px solid #ddd; padding:15px; border-radius:10px; background:#fafafa; }
  .question { border:1px solid #ddd; padding:15px; border-radius:8px; margin-top:15px; position:relative; }
  .remove-btn { position:absolute; top:10px; right:10px; background:#e53935; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
  label { font-weight:500; display:block; margin:8px 0 4px; }
  input, textarea, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px; margin-bottom:8px; }
  .faculty-info { text-align:right; margin-bottom:15px; }
  .faculty-info span { font-weight:bold; margin-left:5px; }
</style>
</head>
<body>

<a class="back-btn" href="faculty_dashboard.html">← Back to Dashboard</a>

<div class="container">
  <div class="faculty-info">
    Faculty: <span id="facultyName">Loading...</span> | ID: <span id="facultyIdDisplay">0</span>
  </div>

  <h1>All Tests</h1>

  <div class="top-bar">
    <input type="text" id="searchBar" placeholder="Search by title, course or date...">
    <button id="showAddTest">+ Add Test</button>
    <input type="file" id="jsonUpload" accept=".json" style="display:none;">
    <button id="uploadJsonBtn">Upload JSON</button>
  </div>

  <table id="testsTable">
    <thead>
      <tr>
        <th>Test ID</th>
        <th>Title</th>
        <th>Course</th>
        <th>Date</th>
        <th>Total Marks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="add-test-form" id="addTestForm">
    <h2>Create New Test</h2>
    <form id="testForm">
      <label for="courseId">Course</label>
      <select id="courseId" required><option value="">Select a course</option></select>

      <label for="testTitle">Title</label>
      <input type="text" id="testTitle" required>

      <label for="testDesc">Description</label>
      <textarea id="testDesc" rows="3"></textarea>

      <label for="testDate">Date</label>
      <input type="date" id="testDate" required>

      <label for="totalMarks">Total Marks</label>
      <input type="number" id="totalMarks" required>

      <div id="questionsContainer"></div>
      <button type="button" id="addQuestion">+ Add Question</button>
      <button type="submit">Save Test</button>
    </form>
  </div>
</div>

<script>
let qCount = 0;
const container = document.getElementById("questionsContainer");
const addForm = document.getElementById("addTestForm");
const testsTableBody = document.querySelector("#testsTable tbody");
const courseSelect = document.getElementById('courseId');

// Load faculty info
const faculty = JSON.parse(localStorage.getItem('loggedFaculty'));
if(faculty){
  document.getElementById('facultyName').innerText = faculty.name;
  document.getElementById('facultyIdDisplay').innerText = faculty.facultyId;
} else {
  alert('Faculty info missing. Redirecting to login.');
  window.location.href = 'login_page.html';
}

// Load courses dynamically
async function loadCoursesForFaculty() {
  try {
    const res = await fetch(`http://localhost:8081/courses?facultyId=${faculty.facultyId}`);
    const courses = await res.json();
    courseSelect.innerHTML = '<option value="">Select a course</option>';
    courses.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.courseId;
      opt.innerText = `${c.courseName} (ID: ${c.courseId})`;
      courseSelect.appendChild(opt);
    });
  } catch(err) {
    console.error(err);
    alert('Failed to load courses.');
  }
}
loadCoursesForFaculty();

// Show Add Test form
document.getElementById("showAddTest").addEventListener("click", () => {
  addForm.style.display = addForm.style.display==="block"?"none":"block";
});

// Add question dynamically
document.getElementById("addQuestion").addEventListener("click", () => {
  qCount++;
  const div = document.createElement("div");
  div.className = "question";
  div.innerHTML = `
    <button type="button" class="remove-btn" onclick="this.parentElement.remove()">✖</button>
    <h3>Question ${qCount}</h3>
    <label>Text</label>
    <input type="text" class="q-text" required>
    <label>Type</label>
    <select class="q-type">
      <option value="MCQ">MCQ</option>
      <option value="SHORT">Short Answer</option>
      <option value="TF">True/False</option>
    </select>
    <div class="mcq-options">
      <label>Option A</label><input type="text" class="optA">
      <label>Option B</label><input type="text" class="optB">
      <label>Option C</label><input type="text" class="optC">
      <label>Option D</label><input type="text" class="optD">
      <label>Correct Answer</label>
      <select class="correct">
        <option value="">Select</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>
    </div>
  `;
  container.appendChild(div);
});

// Submit new test (manual)
document.getElementById("testForm").addEventListener("submit", async e => {
  e.preventDefault();
  if(!courseSelect.value){ alert("Please select a course"); return; }

  const test = {
    title: document.getElementById("testTitle").value,
    description: document.getElementById("testDesc").value,
    testDate: document.getElementById("testDate").value,
    totalMarks: parseInt(document.getElementById("totalMarks").value),
    course: { courseId: parseInt(courseSelect.value) },
    faculty: { facultyId: faculty.facultyId },
    questions: []
  };

  container.querySelectorAll(".question").forEach((q, idx) => {
    let qType = q.querySelector(".q-type").value || 'MCQ';
    test.questions.push({
      text: q.querySelector(".q-text").value || `Question ${idx+1}`,
      type: qType,
      optionA: q.querySelector(".optA")?.value || (qType==='MCQ'? 'Option A':''),
      optionB: q.querySelector(".optB")?.value || (qType==='MCQ'? 'Option B':''),
      optionC: q.querySelector(".optC")?.value || (qType==='MCQ'? 'Option C':''),
      optionD: q.querySelector(".optD")?.value || (qType==='MCQ'? 'Option D':''),
      correctAnswer: q.querySelector(".correct")?.value || 'A'
    });
  });

  try{
    const res = await fetch("http://localhost:8081/tests", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(test)
    });
    if(!res.ok) throw new Error("Failed to save test");
    alert("Test saved successfully!");
    document.getElementById("testForm").reset();
    container.innerHTML = "";
    qCount=0;
    addForm.style.display="none";
    loadTests();
  } catch(err){ console.error(err); alert("Error while saving test."); }
});

// Upload JSON
document.getElementById('uploadJsonBtn').addEventListener('click', ()=> document.getElementById('jsonUpload').click());
document.getElementById('jsonUpload').addEventListener('change', async function(){
  const file = this.files[0];
  if(!file) return;

  try{
    const text = await file.text();
    const uploadedTest = JSON.parse(text);

    uploadedTest.title = uploadedTest.title || 'Untitled Test';
    uploadedTest.faculty = { facultyId: faculty.facultyId };
    if(!uploadedTest.course) uploadedTest.course = { courseId: courseSelect.value };
    uploadedTest.questions = uploadedTest.questions || [];

    uploadedTest.questions.forEach((q, idx)=>{
      q.text = q.text || `Question ${idx+1}`;
      q.type = q.type || 'MCQ';
      q.correctAnswer = q.correctAnswer || 'A';
      if(q.type==='MCQ'){
        q.optionA = q.optionA || 'Option A';
        q.optionB = q.optionB || 'Option B';
        q.optionC = q.optionC || 'Option C';
        q.optionD = q.optionD || 'Option D';
      } else {
        q.optionA = q.optionB = q.optionC = q.optionD = null;
      }
    });

    const res = await fetch("http://localhost:8081/tests", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(uploadedTest)
    });
    if(!res.ok) throw new Error("Failed to upload test");

    alert("Test uploaded successfully!");
    this.value="";
    loadTests();
  } catch(err){
    console.error(err);
    alert("Error uploading JSON: " + err.message);
  }
});

// Load tests
async function loadTests(){
  try{
    const res = await fetch(`http://localhost:8081/tests/faculty/${faculty.facultyId}`);
    const tests = await res.json();
    testsTableBody.innerHTML="";

    tests.forEach(t=>{
      const tr = document.createElement("tr");

      // Use courseName if available, otherwise fallback to course_id
      const courseName = t.course?.courseName || t.course?.courseId || t.course_id || '-';

      const testDate = t.testDate ? new Date(t.testDate).toLocaleDateString() : '-';

      tr.innerHTML = `
        <td>${t.testId || t.test_id}</td>
        <td>${t.title}</td>
        <td>${courseName}</td>
        <td>${testDate}</td>
        <td>${t.totalMarks || t.total_marks}</td>
        <td><button onclick="viewTest(${t.testId || t.test_id})">View</button></td>
      `;
      testsTableBody.appendChild(tr);
    });
  } catch(err){ console.error(err); }
}

function viewTest(testId){ window.location.href=`faculty_view_test.html?testId=${testId}`; }

// Search
document.getElementById("searchBar").addEventListener("input", function(){
  const query = this.value.toLowerCase();
  document.querySelectorAll("#testsTable tbody tr").forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(query)?"":"none";
  });
});

// Initial load
loadTests();
</script>
</body>
</html>
