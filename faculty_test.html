<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty – Tests</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; background:#f4f6f8; margin:0; }
.back-btn { position: fixed; top: 20px; left: 20px; background: #1976d2; color: #fff; padding: 10px 16px; border-radius: 8px; text-decoration: none; z-index: 1000; }
.back-btn:hover { background:#125a9d; }
.container { max-width:1200px; margin:80px auto 40px auto; background:#fff; padding:30px 40px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
h1 { text-align:center; color:#1976d2; margin-bottom:30px; }
.top-bar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
input[type="text"], select, input[type="date"], input[type="number"], textarea { padding:12px 14px; border:1px solid #ccc; border-radius:8px; font-size:16px; width:100%; box-sizing:border-box; }
button { background:#1976d2; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-size:16px; }
button:hover { background:#125a9d; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:12px; border-bottom:1px solid #ddd; text-align:left; }
th { background:#f0f0f0; }
.add-test-form { display:none; margin-top:30px; border:1px solid #ddd; padding:25px; border-radius:12px; background:#fafafa; }
.question { border:1px solid #ddd; padding:15px; border-radius:10px; margin-top:15px; position:relative; }
.remove-btn { position:absolute; top:10px; right:10px; background:#e53935; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; }
label { font-weight:500; display:block; margin:8px 0 6px; }
.faculty-info { text-align:right; margin-bottom:20px; font-size:16px; }
.faculty-info span { font-weight:bold; margin-left:5px; }
#uploadedFileName { margin-left:10px; font-style:italic; }
.mcq-options { margin-top:10px; }
</style>
</head>
<body>

<a class="back-btn" href="faculty_dashboard.html">← Back to Dashboard</a>

<div class="container">
  <div class="faculty-info">
    Faculty: <span id="facultyName">Loading...</span> | ID: <span id="facultyIdDisplay">0</span>
  </div>

  <h1>All Tests</h1>

  <div class="top-bar">
    <input type="text" id="searchBar" placeholder="Search by title, course or date...">
    <button id="showAddTest">+ Add Test</button>
  </div>

  <table id="testsTable">
    <thead>
      <tr>
        <th>Test ID</th>
        <th>Title</th>
        <th>Course</th>
        <th>Date</th>
        <th>Total Marks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="add-test-form" id="addTestForm">
    <h2>Create New Test</h2>
    <form id="testForm">
      <label for="courseId">Course</label>
      <select id="courseId" required><option value="">Select a course</option></select>

      <div style="margin:15px 0;">
        <input type="file" id="jsonUpload" accept=".json" style="display:none;">
        <button type="button" id="uploadJsonBtn">Upload Questions JSON</button>
        <span id="uploadedFileName">No file uploaded</span>
      </div>

      <label for="testTitle">Title</label>
      <input type="text" id="testTitle" required>

      <label for="testDesc">Description</label>
      <textarea id="testDesc" rows="3"></textarea>

      <label for="testDate">Date</label>
      <input type="date" id="testDate" required>

      <label for="totalMarks">Total Marks</label>
      <input type="number" id="totalMarks" required>

      <div id="questionsContainer"></div>
      <button type="button" id="addQuestion">+ Add Question</button>
      <button type="submit">Save Test</button>
    </form>
  </div>
</div>

<script>
let qCount = 0;
const container = document.getElementById("questionsContainer");
const addForm = document.getElementById("addTestForm");
const testsTableBody = document.querySelector("#testsTable tbody");
const courseSelect = document.getElementById('courseId');
const uploadedFileNameSpan = document.getElementById("uploadedFileName");

// Faculty info
const faculty = JSON.parse(localStorage.getItem('loggedFaculty'));
if(faculty){
  document.getElementById('facultyName').innerText = faculty.name;
  document.getElementById('facultyIdDisplay').innerText = faculty.facultyId;
} else {
  alert('Faculty info missing. Redirecting to login.');
  window.location.href = 'login_page.html';
}

// Load courses
async function loadCoursesForFaculty() {
  try {
    const res = await fetch(`http://localhost:8081/courses?facultyId=${faculty.facultyId}`);
    const courses = await res.json();
    courseSelect.innerHTML = '<option value="">Select a course</option>';
    courses.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.courseId;
      opt.innerText = `${c.courseName} (ID: ${c.courseId})`;
      courseSelect.appendChild(opt);
    });
  } catch(err) { console.error(err); alert('Failed to load courses.'); }
}
loadCoursesForFaculty();

// Toggle Add Test form
document.getElementById("showAddTest").addEventListener("click", () => {
  addForm.style.display = addForm.style.display==="block"?"none":"block";
});

// Add question manually
document.getElementById("addQuestion").addEventListener("click", () => addQuestionDiv());

// Add question div
function addQuestionDiv(q = null){
    qCount++;
    const div = document.createElement("div");
    div.className = "question";

    const optionsHTML = `
        <label>Option A</label><input type="text" class="optA" value="${q?.optionA || ''}" required>
        <label>Option B</label><input type="text" class="optB" value="${q?.optionB || ''}" required>
        <label>Option C</label><input type="text" class="optC" value="${q?.optionC || ''}" required>
        <label>Option D</label><input type="text" class="optD" value="${q?.optionD || ''}" required>
        <label>Correct Answer</label>
        <select class="correct" required>
            <option value="">Select</option>
            <option value="A" ${q?.correctOption==='A'?'selected':''}>A</option>
            <option value="B" ${q?.correctOption==='B'?'selected':''}>B</option>
            <option value="C" ${q?.correctOption==='C'?'selected':''}>C</option>
            <option value="D" ${q?.correctOption==='D'?'selected':''}>D</option>
        </select>
    `;

    div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">✖</button>
        <h3>Question ${qCount}</h3>
        <label>Text</label>
        <input type="text" class="q-text" required value="${q?.questionText || ''}">
        <div class="mcq-options">${optionsHTML}</div>
    `;
    container.appendChild(div);
}

// Upload JSON
document.getElementById("uploadJsonBtn").addEventListener("click", ()=>document.getElementById("jsonUpload").click());
document.getElementById("jsonUpload").addEventListener("change", async function(){
    const file = this.files[0];
    if(!file) return;
    uploadedFileNameSpan.innerText = file.name;
    try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data.questions || !Array.isArray(data.questions)){ 
            alert("JSON must have 'questions' array."); 
            return; 
        }
        container.innerHTML = ""; 
        qCount = 0;

        data.questions.forEach(q=>{
            const transformed = {
                questionText: q.questionText || '',
                optionA: q.optionA || '',
                optionB: q.optionB || '',
                optionC: q.optionC || '',
                optionD: q.optionD || '',
                correctOption: q.correctOption || ''
            };
            addQuestionDiv(transformed);
        });

        document.getElementById("testTitle").value = data.title || '';
        document.getElementById("testDesc").value = data.description || '';
        document.getElementById("testDate").value = data.testDate || '';
        document.getElementById("totalMarks").value = data.totalMarks || '';
        if(data.course?.courseId) courseSelect.value = data.course.courseId;

    }catch(err){ 
        alert("Invalid JSON"); 
        console.error(err); 
    }
});

// Save test + questions
document.getElementById("testForm").addEventListener("submit", async function(e){
    e.preventDefault();
    if(!courseSelect.value){ alert("Select a course"); return; }

    const questionsArray = Array.from(document.querySelectorAll(".question")).map(qDiv => ({
        questionText: qDiv.querySelector(".q-text").value.trim(),
        optionA: qDiv.querySelector(".optA")?.value.trim() || '',
        optionB: qDiv.querySelector(".optB")?.value.trim() || '',
        optionC: qDiv.querySelector(".optC")?.value.trim() || '',
        optionD: qDiv.querySelector(".optD")?.value.trim() || '',
        correctOption: qDiv.querySelector(".correct")?.value
    }));

    if(questionsArray.length === 0){ alert("Add at least one question"); return; }

    // Validate each question
    for (const q of questionsArray) {
        if(!q.questionText || !q.optionA || !q.optionB || !q.optionC || !q.optionD || !q.correctOption){
            alert("Each question must have text, all options, and a correct option");
            return;
        }
    }

    const testData = {
        title: document.getElementById("testTitle").value.trim(),
        description: document.getElementById("testDesc").value.trim(),
        testDate: document.getElementById("testDate").value,
        totalMarks: parseInt(document.getElementById("totalMarks").value),
        course: { courseId: parseInt(courseSelect.value) },
        faculty: { facultyId: faculty.facultyId },
        questions: questionsArray
    };

    try {
        const res = await fetch("http://localhost:8081/tests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testData)
        });
        if(!res.ok){
            const err = await res.text();
            throw new Error(err || "Failed to save test");
        }
        const savedTest = await res.json();
        alert(`Test saved successfully! Test ID: ${savedTest.testId}`);
        container.innerHTML = "";
        qCount = 0;
        this.reset();
        uploadedFileNameSpan.innerText = "No file uploaded";
        loadTests();
    } catch(err){
        console.error(err);
        alert("Error saving test: " + err.message);
    }
});

// Load tests
async function loadTests(){
    try{
        const res = await fetch(`http://localhost:8081/tests?facultyId=${faculty.facultyId}`);
        const data = await res.json();
        testsTableBody.innerHTML = "";
        if(Array.isArray(data) && data.length > 0){
            data.forEach(t => appendTestRow(t));
        } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="6" style="text-align:center; color:#999;">No tests found.</td>`;
            testsTableBody.appendChild(tr);
        }
    }catch(err){ console.error(err); alert("Failed to load tests."); }
}

// Append test row
function appendTestRow(t){
    const tr = document.createElement("tr");
    const testId = t.testId ?? '-';
    const title = t.title ?? '-';
    const courseName = t.course?.courseName ?? '-';
    const testDate = t.testDate ? new Date(t.testDate).toLocaleDateString() : '-';
    const totalMarks = t.totalMarks ?? '-';
    tr.innerHTML = `
        <td>${testId}</td>
        <td>${title}</td>
        <td>${courseName}</td>
        <td>${testDate}</td>
        <td>${totalMarks}</td>
        <td><button onclick="viewTest(${testId})">View</button></td>
    `;
    testsTableBody.appendChild(tr);
}

function viewTest(testId){ window.location.href=`faculty_view_test.html?testId=${testId}`; }

// Search
document.getElementById("searchBar").addEventListener("input", function(){
    const query = this.value.toLowerCase();
    document.querySelectorAll("#testsTable tbody tr").forEach(row=>{
        row.style.display = row.innerText.toLowerCase().includes(query)?"":"none";
    });
});

loadTests();
</script>
</body>
</html>
