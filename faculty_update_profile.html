<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Update Faculty Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(90deg,#e2e2e2,#c9d6ff);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
}
.main-content {
    width:100%;
    max-width:700px;
    padding:30px 40px;
    background:#fff;
    border-radius:15px;
    box-shadow:0 0 25px rgba(0,0,0,0.1);
}
h1 { text-align:center; color:#333; margin-bottom:30px; }
.form-card { display:flex; flex-direction:column; gap:18px; }
label { font-weight:500; color:#333; margin-bottom:5px; }
input { width:100%; padding:12px 15px; border-radius:8px; border:1px solid #ccc; font-size:15px; box-sizing:border-box; }
input:disabled { background:#f0f0f0; color:#666; }
.btn { width:100%; padding:12px; background:#7494ec; border:none; border-radius:8px; color:#fff; font-size:16px; font-weight:600; cursor:pointer; transition:0.3s; }
.btn:hover { background:#5a78d1; }
.alert { margin-bottom:12px; padding:10px; color:#fff; border-radius:5px; display:none; }
.alert.success { background-color:#4CAF50; }
.alert.error { background-color:#f44336; }
</style>
</head>
<body>

<div class="main-content">
  <h1>Update Your Profile</h1>
  <div class="form-card">
    <div id="alert" class="alert"></div>

    <form id="updateProfileForm">
      <label>Full Name</label>
      <input type="text" id="fullName" name="fullName" required>

      <label>Email</label>
      <input type="email" id="email" name="email" disabled>

      <label>Department</label>
      <input type="text" id="department" name="department" required>

      <label>Designation</label>
      <input type="text" id="designation" name="designation" required>

      <label>Contact No</label>
      <input type="text" id="contactNo" name="contactNo" required>

      <h3>Course</h3>
      <label>Course Name</label>
      <input type="text" id="courseName" name="courseName" required>
      <label>Credits</label>
      <input type="number" id="credits" name="credits" min="0" required>

      <input type="hidden" id="courseId" name="courseId">

      <button type="submit" class="btn">Save Changes</button>
    </form>
  </div>
</div>

<script>
const FACULTY_API = 'http://127.0.0.1:8081/faculty';
const alertBox = document.getElementById('alert');

// show success/error
function showAlert(message, type='success') {
  alertBox.textContent = message;
  alertBox.className = `alert ${type}`;
  alertBox.style.display = 'block';
  setTimeout(() => alertBox.style.display='none', 4000);
}

// load faculty details
document.addEventListener('DOMContentLoaded', async () => {
  const stored = JSON.parse(localStorage.getItem('loggedFaculty'));
  if (!stored?.facultyId) {
    alert('You are not logged in!');
    window.location.href = 'login_page.html';
    return;
  }

  try {
    const res = await fetch(`${FACULTY_API}/${stored.facultyId}`);
    if(!res.ok) throw new Error(`Server returned ${res.status}`);
    const faculty = await res.json();

    document.getElementById('fullName').value = faculty.name ?? '';
    document.getElementById('email').value = faculty.email ?? '';
    document.getElementById('department').value = faculty.department ?? '';
    document.getElementById('designation').value = faculty.designation ?? '';
    document.getElementById('contactNo').value = faculty.contactNo ?? '';

    if(Array.isArray(faculty.courses) && faculty.courses.length > 0){
      const c = faculty.courses[0]; // only first course
      document.getElementById('courseName').value = c.courseName ?? '';
      document.getElementById('credits').value = c.credits ?? 0;
      document.getElementById('courseId').value = c.courseId ?? '';
    }

  } catch(err) {
    console.error(err);
    showAlert('Failed to load profile: '+err.message,'error');
  }
});

// submit profile changes
document.getElementById('updateProfileForm').addEventListener('submit', async e => {
  e.preventDefault();
  const stored = JSON.parse(localStorage.getItem('loggedFaculty'));
  if(!stored?.facultyId) return;

  const payload = {
    name: document.getElementById('fullName').value.trim(),
    department: document.getElementById('department').value.trim(),
    designation: document.getElementById('designation').value.trim(),
    contactNo: document.getElementById('contactNo').value.trim(),
    courses: [{
      courseId: document.getElementById('courseId').value || null,
      courseName: document.getElementById('courseName').value.trim(),
      credits: parseInt(document.getElementById('credits').value) || 0
    }]
  };

  try {
    const res = await fetch(`${FACULTY_API}/${stored.facultyId}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });

    if(!res.ok) throw new Error(`Update failed (${res.status})`);
    const updated = await res.json().catch(()=>({}));
    if(updated.facultyId) localStorage.setItem('loggedFaculty',JSON.stringify(updated));
    showAlert('Profile updated successfully!','success');
    setTimeout(()=>window.location.href='faculty_dashboard.html',1500);
  } catch(err) {
    console.error(err);
    showAlert('Error updating profile: '+err.message,'error');
  }
});
</script>

</body>
</html>
