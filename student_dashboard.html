<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard</title>

<!-- Google Icons & Font -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
<link href="student_dashboard.css" rel="stylesheet">
</head>
<body>

<!-- Sidebar Menu -->
<div class="menu">
  <ul class="menu-content">
    <li><a href="#" id="homeTabBtn"><span class="material-symbols-outlined">home</span><span>Home</span></a></li>
    <li><a href="campus_connect.html"><span class="material-symbols-outlined">dashboard</span><span>Campus Connect</span></a></li>
    <li><a href="#" id="profileTabBtn"><span class="material-symbols-outlined">person</span><span>Profile</span></a></li>
    <li><a href="performance.html"><span class="material-symbols-outlined">analytics</span><span>Performance</span></a></li>
    <li><a href="#" id="testsTabBtn"><span class="material-symbols-outlined">description</span><span>Tests</span></a></li>
    <li><a href="#" id="hackathonTabBtn"><span class="material-symbols-outlined">emoji_events</span><span>Hackathons</span></a></li>
    <li><a href="#" id="courseTabBtn"><span class="material-symbols-outlined">menu_book</span><span>Courses</span></a></li>
    <li><a href="#" onclick="logout()"><span class="material-symbols-outlined">logout</span><span>Logout</span></a></li>
  </ul>
</div>

<!-- Main Content -->
<div class="main-content">

  <!-- Home -->
  <div id="homeSection">
    <h1>Welcome, <span id="greetingName">Student</span> üëã</h1>
    <p class="hero-subtext">‚ÄúConsistency is the key to success. Keep learning today!‚Äù</p>
    <div class="home-buttons">
      <button class="btn" id="homeTestBtn">Take Test</button>
      <button class="btn" id="homeHackathonBtn">Hackathons</button>
      <button class="btn" id="homeResultsBtn">Results</button>
      <button class="btn" id="homeProfileBtn">Profile</button>
      <button class="btn" id="homeCampusConnectBtn">Campus Connect</button>
      <button class="btn" id="homeCourseBtn">Courses</button>
    </div>
  </div>

  <!-- Profile -->
  <div class="profile-card" id="profileSection" style="display:none;">
    <h2>Profile Information</h2>
    <div class="profile-item"><span>Name:</span> <span id="studentName">Loading...</span></div>
    <div class="profile-item"><span>Email:</span> <span id="studentEmail">Loading...</span></div>
    <div class="profile-item"><span>Class:</span> <span id="studentClass">Loading...</span></div>
    <div class="profile-item"><span>Stream:</span> <span id="studentDept">Loading...</span></div>
    <div class="profile-item"><span>Tests Attempted:</span> <span id="testsAttempted">0</span></div>
    <div class="profile-item"><span>Test Average:</span> <span id="testAverage">0</span></div>
    <div class="profile-item"><span>Hackathons Participated:</span> <span id="hackathonsParticipated">0</span></div>
    <div class="profile-item"><span>Hackathon Rating:</span> <span id="hackathonRating">0</span></div>
    <button class="btn" id="updateProfileBtn">Update Profile</button>
  </div>

  <!-- Tests -->
  <div id="testsSection" style="display:none;">
    <h2 class="section-title">Available Tests</h2>
    <div id="availableTests"></div>

    <div id="testAttemptSection" style="display:none;">
      <h3 id="testTitleDisplay"></h3>
      <form id="attemptTestForm"></form>
    </div>
  </div>

  <!-- Hackathons -->
  <div id="hackathonSection" style="display:none;">
    <h2>Available Hackathons</h2>
    <div id="hackathonListStudent"></div>
  </div>

  <!-- Courses -->
  <div id="courseSection" style="display:none;">
    <h2 class="section-title">Your Courses</h2>
    <div id="courseList"></div>
  </div>

</div>

<!-- JavaScript -->
<script>
const API_BASE_STUDENT = 'http://localhost:8081/students';
const API_BASE_TESTS   = 'http://localhost:8081/tests';
const API_BASE_HACK    = 'http://localhost:8081/hackathons';
const API_BASE_COURSE  = 'http://localhost:8081/courses';

function logout() {
  localStorage.removeItem('loggedStudent');
  window.location.href='login_page.html';
}

// Load student info
document.addEventListener('DOMContentLoaded', async () => {
  const stored = JSON.parse(localStorage.getItem('loggedStudent'));
  if (!stored || !stored.studentId) { logout(); return; }
  try {
    const res = await fetch(`${API_BASE_STUDENT}/${stored.studentId}`);
    if (!res.ok) throw new Error('Failed to fetch student');
    const student = await res.json();
    student.attemptedTests = student.attemptedTests || []; // initialize attemptedTests
    document.getElementById('greetingName').innerText = student.fullName?.split(' ')[0] || "Student";
    localStorage.setItem('loggedStudent', JSON.stringify(student));
  } catch(err) {
    console.error("Error loading student:", err);
    alert("Failed to load student");
    logout();
  }
});

function showSection(id){
  ['homeSection','profileSection','testsSection','hackathonSection','courseSection']
    .forEach(sec => document.getElementById(sec).style.display='none');
  document.getElementById(id).style.display='block';
}

// Load profile and update stats
function loadProfile() {
  const st = JSON.parse(localStorage.getItem('loggedStudent'));
  if (!st) return;

  const attemptedTests = st.attemptedTests || [];
  const totalTests = attemptedTests.length;
  const totalScore = attemptedTests.reduce((sum, t) => sum + t.score, 0);
  const totalMarks = attemptedTests.reduce((sum, t) => sum + (t.totalMarks || 1), 0);
  const average = totalMarks > 0 ? ((totalScore / totalMarks) * 100).toFixed(2) : 0;

  document.getElementById('studentName').innerText = st.fullName || "N/A";
  document.getElementById('studentEmail').innerText = st.email || "N/A";
  document.getElementById('studentClass').innerText = st.classYear || "N/A";
  document.getElementById('studentDept').innerText = st.department || "N/A";
  document.getElementById('testsAttempted').innerText = totalTests;
  document.getElementById('testAverage').innerText = average;
  document.getElementById('hackathonsParticipated').innerText = st.hackathonsParticipated || 0;
  document.getElementById('hackathonRating').innerText = st.hackathonRating || 0;

  showSection('profileSection');
}

// Load available tests
async function loadAvailableTests() {
  showSection('testsSection');
  document.getElementById('testAttemptSection').style.display='none';
  document.getElementById('availableTests').style.display='block';
  try {
    const res = await fetch(API_BASE_TESTS);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const tests = await res.json();
    const cont = document.getElementById('availableTests');
    cont.innerHTML = '';
    if(tests.length === 0) cont.innerHTML = '<p class="no-tests">No tests available</p>';

    const student = JSON.parse(localStorage.getItem('loggedStudent'));
    const attemptedIds = student.attemptedTests.map(t => t.testId);

    tests.forEach(t => {
      const div = document.createElement('div');
      div.className = 'test-card';

      let resultHTML = '';
      if (attemptedIds.includes(t.testId)) {
        const resObj = student.attemptedTests.find(at => at.testId === t.testId);
        resultHTML = `<p class="result-text">Score: ${resObj.score} / ${resObj.totalMarks}, Grade: ${resObj.grade}</p>`;
      }

      div.innerHTML = `
        <div class="test-info">
          <h3>${t.title || "Untitled Test"}</h3>
          <p>${t.description || "No description available"}</p>
          ${resultHTML}
        </div>
        ${attemptedIds.includes(t.testId) ? '' : `<button class="btn attempt-btn" onclick="attemptTest(${t.testId})">Attempt Test</button>`}
      `;
      cont.appendChild(div);
    });
  } catch(err) {
    console.error("Error loading tests:", err);
    alert('Failed to load tests.');
  }
}

// Attempt a test
async function attemptTest(id) {
  try {
    const res = await fetch(`${API_BASE_TESTS}/${id}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const test = await res.json();

    document.getElementById('availableTests').style.display='none';
    document.getElementById('testAttemptSection').style.display='block';
    document.getElementById('testTitleDisplay').innerText = test.title || "Untitled Test";

    const form = document.getElementById('attemptTestForm');
    form.innerHTML = '';

    test.questions?.forEach((q,i) => {
      const block = document.createElement('div');
      block.className='question-block';
      block.innerHTML = `<label>${i+1}. ${q.questionText}</label><br>
        ${['A','B','C','D'].map(opt => `
          <input type="radio" name="q${q.questionId}" value="${opt}" required> ${q['option'+opt]}<br>
        `).join('')}`;
      form.appendChild(block);
    });

    const btn=document.createElement('button');
    btn.type='submit'; btn.className='btn-submit'; btn.innerText='Submit Test';
    form.appendChild(btn);

    form.onsubmit = async e => {
      e.preventDefault();
      const student = JSON.parse(localStorage.getItem('loggedStudent'));
      const answers = test.questions.map(q => {
        const sel = form.querySelector(`input[name="q${q.questionId}"]:checked`);
        return { questionId: q.questionId, selectedOption: sel?.value || "" };
      });

      try {
        const r = await fetch(`${API_BASE_TESTS}/${id}/submit`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ studentId: student.studentId, answers })
        });
        if(!r.ok) throw new Error('Submit failed');
        const result = await r.json();

        // Save attempt in localStorage
        student.attemptedTests = student.attemptedTests || [];
        const index = student.attemptedTests.findIndex(at => at.testId === id);
        if (index !== -1) student.attemptedTests[index] = { testId: id, score: result.score, grade: result.grade, totalMarks: result.totalMarks };
        else student.attemptedTests.push({ testId: id, score: result.score, grade: result.grade, totalMarks: result.totalMarks });
        localStorage.setItem('loggedStudent', JSON.stringify(student));

        alert(`You scored ${result.score} / ${result.totalMarks}, Grade: ${result.grade}`);
        document.getElementById('testAttemptSection').style.display='none';
        loadAvailableTests();
        loadProfile();
      } catch(err){ console.error(err); alert('Submit failed'); }
    };

  } catch(err) {
    console.error("Error loading test:", err);
    alert('Failed to load test');
  }
}

// Hackathons
async function loadStudentHackathons() {
  const st = JSON.parse(localStorage.getItem('loggedStudent'));
  if(!st) return;
  try {
    const res = await fetch(API_BASE_HACK);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const hacks = await res.json();
    const cont = document.getElementById('hackathonListStudent');
    cont.innerHTML = '';
    hacks.forEach(h => {
      const joined = h.acceptedStudents?.includes(st.studentId);
      const div = document.createElement('div');
      div.className='card';
      div.innerHTML = `
        <h3>${h.title}</h3>
        <p>${h.description||''}</p>
        <button class="btn" onclick="joinHackathon(${h.id})" ${joined?'disabled':''}>
          ${joined?'Joined':'Join'}
        </button>`;
      cont.appendChild(div);
    });
  } catch(err){ console.error(err); alert('Failed to load hackathons'); }
}

async function joinHackathon(id) {
  const st = JSON.parse(localStorage.getItem('loggedStudent'));
  try {
    await fetch(`${API_BASE_HACK}/join`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ hackathonId:id, studentId:st.studentId })
    });
    loadStudentHackathons();
  } catch(err){ console.error(err); alert('Failed to join hackathon'); }
}

/* ====== EVENT LISTENERS ====== */
document.getElementById('profileTabBtn').addEventListener('click', loadProfile);
document.getElementById('homeTabBtn').addEventListener('click',()=>showSection('homeSection'));
document.getElementById('homeTestBtn').addEventListener('click', loadAvailableTests);
document.getElementById('testsTabBtn').addEventListener('click', loadAvailableTests);
document.getElementById('homeHackathonBtn').addEventListener('click', ()=>{showSection('hackathonSection'); loadStudentHackathons();});
document.getElementById('hackathonTabBtn').addEventListener('click', ()=>{showSection('hackathonSection'); loadStudentHackathons();});
document.getElementById('homeResultsBtn').addEventListener('click', ()=>window.location.href='performance.html');
document.getElementById('homeProfileBtn').addEventListener('click', loadProfile);
document.getElementById('homeCampusConnectBtn').addEventListener('click', ()=>window.location.href='campus_connect.html');
document.getElementById('updateProfileBtn').addEventListener('click', ()=>window.location.href='update_profile.html');
</script>

</body>
</html>
